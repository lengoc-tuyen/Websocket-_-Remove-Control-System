<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>ƒêƒÉng nh·∫≠p ‚Äì Christmas LAN Remote</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body {
      height: 100vh;
      background: url("image/door-bg.jpg") center/cover no-repeat fixed;
      font-family: system-ui, "Segoe UI", sans-serif;
      position: relative;
      overflow: hidden;
    }

    body::before {
      content:"";
      position:fixed;
      inset:0;
      background: radial-gradient(circle at top, rgba(15,23,42,0.25), rgba(15,23,42,0.6));
      pointer-events:none;
      z-index:0;
    }

    .wreath-wrap {
      position: fixed;
      top: 26vh;
      left: 50%;
      transform: translate(-50%, -50%);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      z-index: 2;
    }

    .wreath {
      width: 340px;
      height: 340px;
      background: url("image/wreath.png") center/contain no-repeat;
      position: relative;
      display:flex;
      align-items:center;
      justify-content:center;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,0.7));
      animation: leds 2.2s ease-in-out infinite, wreath-drop 0.8s ease-out;
    }

    @keyframes leds {
      0%, 100% { filter: drop-shadow(0 8px 22px rgba(239,68,68,0.7)); }
      50%      { filter: drop-shadow(0 8px 26px rgba(250,204,21,0.95)); }
    }

    @keyframes wreath-drop {
      0%   { transform: scale(0.7) translateY(-40px); opacity:0; }
      70%  { transform: scale(1.05) translateY(6px);  opacity:1; }
      100% { transform: scale(1)    translateY(0);    opacity:1; }
    }

    .wreath-inner {
      width: 240px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:14px;
      transform: translateY(8px);
    }

    .tabs {
      display:flex;
      gap:8px;
      width:100%;
    }

    .tab-btn {
      flex:1;
      padding: 10px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.7);
      background: rgba(255,255,255,0.25);
      color:#fff;
      font-weight: 800;
      cursor:pointer;
      transition: transform .15s, background .15s;
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
    }
    .tab-btn.active {
      background: rgba(255,255,255,0.9);
      color:#111827;
      text-shadow:none;
    }
    .tab-btn:hover { transform: translateY(-1px); }

    .field {
      width:100%;
      padding: 12px 10px;
      border-radius: 12px;
      border: 2px solid #ffffff;
      background: rgba(255,255,255,0.92);
      text-align: center;
      font-size: 14px;
      font-weight: 800;
      color: #111827;
      outline: none;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .field::placeholder { color:#6b7280; font-weight:700; }

    .primary-btn {
      width: 100%;
      padding: 12px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 900;
      background: #f97316;
      border:none;
      color:#111827;
      cursor:pointer;
      box-shadow:0 4px 14px rgba(0,0,0,0.5);
      transition: transform 0.2s, box-shadow 0.2s, background 0.2s;
    }
    .primary-btn:hover {
      background:#fb923c;
      transform:translateY(-2px);
      box-shadow:0 6px 18px rgba(0,0,0,0.7);
    }

    .hint {
      margin-top: 2px;
      font-size: 12px;
      color:#e5e7eb;
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
      text-align:center;
      line-height: 1.35;
    }

    .msg {
      width:100%;
      font-size: 12px;
      font-weight: 800;
      text-align:center;
      padding: 8px 10px;
      border-radius: 12px;
      display:none;
    }
    .msg.ok { background: rgba(34,197,94,0.2); color:#dcfce7; border:1px solid rgba(34,197,94,0.45); }
    .msg.err { background: rgba(239,68,68,0.18); color:#fee2e2; border:1px solid rgba(239,68,68,0.45); }

    .bottom-links {
      position: fixed;
      bottom: 10px;
      left: 0;
      right: 0;
      text-align: center;
      z-index: 2;
      font-size: 12px;
      color:#e5e7eb;
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
    }

    .snowflake {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: 1;
      animation: snow-spin 6s linear infinite;
    }
    @keyframes snow-spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* Door opening transition */
    body.door-opening .wreath-wrap .wreath { animation: wreath-zoom 0.9s ease-in forwards; }
    @keyframes wreath-zoom {
      0%   { transform: scale(1) translateY(0);    opacity:1; }
      40%  { transform: scale(1.15) translateY(-10px); }
      100% { transform: scale(0.4) translateY(-120px); opacity:0; }
    }
    body.door-opening::before { animation: fadeout-bg 0.9s ease-in forwards; }
    @keyframes fadeout-bg {
      0%   { background: radial-gradient(circle at top, rgba(15,23,42,0.25), rgba(15,23,42,0.6)); }
      100% { background: rgba(15,23,42,1); }
    }

    @media (max-width: 768px) {
      .wreath-wrap { top: 48%; }
      .wreath { width: 300px; height: 300px; }
      .wreath-inner { width: 220px; }
    }

    /* Snowman Chatbot */
    #snowman-chatbot{
      position: fixed;
      right: 16px;
      bottom: 16px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .snowman-img{
      width: 110px;
      height: auto;
      cursor: pointer;
      user-select: none;
      filter: drop-shadow(0 10px 20px rgba(0,0,0,0.55));
    }
    .chat-bubble{
      position: relative;
      background: rgba(255,255,255,0.92);
      color: #111827;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      box-shadow: 0 6px 14px rgba(0,0,0,0.4);
      border: 1px solid rgba(15,23,42,0.25);
      opacity: 0;
      transform: translateY(10px);
      transition: opacity .35s ease, transform .35s ease;
      white-space: nowrap;
    }
    .chat-bubble::after{
      content: "";
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 6px 6px 0 6px;
      border-style: solid;
      border-color: rgba(255,255,255,0.92) transparent transparent transparent;
    }
  </style>
</head>

<body>
  <!-- LOGIN VIEW -->
  <div id="view-login">
    <div class="wreath-wrap">
      <div class="wreath">
        <div class="wreath-inner">
          <div class="tabs">
            <button class="tab-btn active" id="tabLogin">ƒêƒÉng nh·∫≠p</button>
            <button class="tab-btn" id="tabRegister">ƒêƒÉng k√Ω</button>
          </div>

          <div id="msg" class="msg"></div>

          <div id="loginForm">
            <input class="field" type="text" id="loginUser" placeholder="Username" autocomplete="username" />
            <input class="field" type="password" id="loginPass" placeholder="Password" autocomplete="current-password" />
            <button class="primary-btn" id="loginBtn">ƒêƒÉng nh·∫≠p üéÑ</button>
            <div class="hint">ƒêƒÉng nh·∫≠p xong m·ªõi ƒë∆∞·ª£c v√†o h·ªá th·ªëng.</div>
          </div>

          <div id="registerForm" style="display:none;">
            <input class="field" type="text" id="regUser" placeholder="Username" autocomplete="username" />
            <input class="field" type="password" id="regPass" placeholder="Password" autocomplete="new-password" />
            <input class="field" type="text" id="regKey" placeholder="System Key (b·∫Øt bu·ªôc)" />
            <button class="primary-btn" id="registerBtn">ƒêƒÉng k√Ω ‚ùÑ</button>
            <div class="hint">ƒêƒÉng k√Ω xong s·∫Ω t·ª± chuy·ªÉn v·ªÅ tab ƒêƒÉng nh·∫≠p.</div>
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-links">¬© ƒê·ªì √°n M·∫°ng M√°y T√≠nh ‚Äì Christmas LAN Remote ‚ùÑ</div>
  </div>

  <!-- MAIN VIEW (SPA inject v√†o ƒë√¢y) -->
  <div id="view-main" style="display:none;"></div>

  <audio id="bellSound" src="bell.mp3" preload="auto"></audio>

  <!-- Background Music -->
  <audio id="bgMusic" src="music.mp3" loop preload="auto"></audio>

  <!-- Snowman Chatbot -->
  <div id="snowman-chatbot">
    <div id="snowmanBubble" class="chat-bubble">Xin ch√†o</div>
    <img src="MainWeb/giphy.gif" alt="Snowman Chatbot" class="snowman-img">
  </div>

  <script>
    // ================== CONFIG ==================
    const PUBLISHER_SYSTEM_KEY = "DATDINHTUYEN";
    const LS_USERS   = "lan_remote_users";          // { username: password }
    const LS_SESSION = "lan_remote_logged_in";      // username

    // B·∫ÆT BU·ªòC login m·ªói l·∫ßn v√†o trang (b·∫°n ƒëang l√†m ƒë√∫ng √Ω n√†y)
    localStorage.removeItem(LS_SESSION);

    // ================== SNOW ==================
    (function createSnow() {
      const numFlakes = 30;
      const flakes = [];
      const w = window.innerWidth;
      const h = window.innerHeight;

      for (let i = 0; i < numFlakes; i++) {
        const img = document.createElement("img");
        img.src = "image/snow.png";
        img.className = "snowflake";

        const size = Math.random() * 25 + 20;
        img.style.width = size + "px";
        img.style.top = Math.random() * h + "px";
        img.style.left = Math.random() * w + "px";
        img.style.opacity = (Math.random() * 0.7 + 0.3).toString();

        document.body.appendChild(img);
        flakes.push({ el: img, speed: Math.random() * 1.5 + 0.5, drift: Math.random() * 0.6 + 0.2 });
      }

      function animate() {
        const h = window.innerHeight;
        const w = window.innerWidth;

        flakes.forEach(flake => {
          let top = parseFloat(flake.el.style.top);
          let left = parseFloat(flake.el.style.left);

          top += flake.speed;
          left += Math.sin(top / 40) * flake.drift;

          if (top > h) { top = -50; left = Math.random() * w; }

          flake.el.style.top = top + "px";
          flake.el.style.left = left + "px";
        });

        requestAnimationFrame(animate);
      }
      animate();
    })();

    // ================== MUSIC AUTOPLAY (b·ªã browser ch·∫∑n n·∫øu ch∆∞a t∆∞∆°ng t√°c) ==================
    (function () {
      const bg = document.getElementById("bgMusic");
      if (!bg) return;
      bg.volume = 0.35;

      bg.play().catch(() => {});
      const startOnce = () => {
        bg.play().catch(() => {});
        window.removeEventListener("click", startOnce);
        window.removeEventListener("keydown", startOnce);
        window.removeEventListener("touchstart", startOnce);
      };
      window.addEventListener("click", startOnce);
      window.addEventListener("keydown", startOnce);
      window.addEventListener("touchstart", startOnce);
    })();

    // ================== CHATBOT HELLO ==================
    (function () {
      const bubble = document.getElementById("snowmanBubble");
      const img = document.querySelector("#snowman-chatbot .snowman-img");
      if (!bubble) return;

      function showHello() {
        bubble.textContent = "Xin ch√†o";
        bubble.style.opacity = "1";
        bubble.style.transform = "translateY(0)";
        setTimeout(() => {
          bubble.style.opacity = "0";
          bubble.style.transform = "translateY(10px)";
        }, 2000);
      }
      showHello();
      setInterval(showHello, 5000);

      if (img) {
        img.addEventListener("click", () => {
          bubble.textContent = "B·∫°n c·∫ßn m√¨nh gi√∫p g√¨ n√®? ü§ñ";
          bubble.style.opacity = "1";
          bubble.style.transform = "translateY(0)";
          setTimeout(() => {
            bubble.style.opacity = "0";
            bubble.style.transform = "translateY(10px)";
          }, 2500);
        });
      }
    })();

    // ================== UI HELPERS ==================
    const tabLogin = document.getElementById("tabLogin");
    const tabRegister = document.getElementById("tabRegister");
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const msgBox = document.getElementById("msg");
    const bell = document.getElementById("bellSound");

    function setTab(mode) {
      const isLogin = mode === "login";
      tabLogin.classList.toggle("active", isLogin);
      tabRegister.classList.toggle("active", !isLogin);
      loginForm.style.display = isLogin ? "block" : "none";
      registerForm.style.display = isLogin ? "none" : "block";
      hideMsg();
    }
    function showMsg(text, type) {
      msgBox.textContent = text;
      msgBox.className = "msg " + (type === "ok" ? "ok" : "err");
      msgBox.style.display = "block";
    }
    function hideMsg() { msgBox.style.display = "none"; }

    function loadUsers() {
      try { return JSON.parse(localStorage.getItem(LS_USERS) || "{}"); }
      catch { return {}; }
    }
    function saveUsers(users) { localStorage.setItem(LS_USERS, JSON.stringify(users)); }

    tabLogin.addEventListener("click", () => setTab("login"));
    tabRegister.addEventListener("click", () => setTab("register"));

    // ================== SPA CORE ==================
    function loadScriptOnce(src, attrName) {
      return new Promise((resolve, reject) => {
        if (document.querySelector(`script[${attrName}="1"]`)) return resolve();
        const s = document.createElement("script");
        s.src = src;
        s.async = false;
        s.setAttribute(attrName, "1");
        s.onload = resolve;
        s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    async function ensureSignalR() {
      if (window.signalR) return;
      await new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js";
        s.onload = resolve;
        s.onerror = reject;
        document.head.appendChild(s);
      });
    }

    // ch·∫°y l·∫°i c√°c script n·∫±m trong MainWeb/index.html (v√¨ innerHTML kh√¥ng t·ª± ch·∫°y script)
    function runInlineScriptsFrom(doc) {
      const scripts = Array.from(doc.querySelectorAll("script"));
      scripts.forEach(sc => {
        // n·∫øu l√† external script th√¨ b·ªè (m√¨nh ch·ªß ƒë·ªông load ui.js/connection.js ·ªü d∆∞·ªõi)
        if (sc.src) return;
        const s2 = document.createElement("script");
        s2.textContent = sc.textContent || "";
        document.body.appendChild(s2);
      });
    }

    async function spaLoadMain() {
      const loginView = document.getElementById("view-login");
      const mainView  = document.getElementById("view-main");

      try {
        const res = await fetch("MainWeb/index.html", { cache: "no-store" });
        if (!res.ok) throw new Error("Kh√¥ng t·∫£i ƒë∆∞·ª£c MainWeb/index.html (HTTP " + res.status + ")");

        const htmlText = await res.text();
        const doc = new DOMParser().parseFromString(htmlText, "text/html");

        // Inject HTML main
        mainView.innerHTML = doc.body.innerHTML;

        // Load CSS main
        if (!document.querySelector('link[data-main-style="1"]')) {
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = "MainWeb/style.css";
          link.setAttribute("data-main-style", "1");
          document.head.appendChild(link);
        }

        // SignalR + main scripts
        await ensureSignalR();
        await loadScriptOnce("MainWeb/ui.js", "data-ui-js");
        await loadScriptOnce("MainWeb/connection.js", "data-conn-js");

        // N·∫øu main c√≥ inline script (hi·∫øm) th√¨ ch·∫°y l·∫°i
        runInlineScriptsFrom(doc);

        // Bind events (SPA)
        if (window.initMainBindings) window.initMainBindings();

        // Show main, hide login
        loginView.style.display = "none";
        mainView.style.display = "block";

      } catch (err) {
        console.error(err);
        showMsg("L·ªói load main: " + (err?.message || err), "err");
        // gi·ªØ nguy√™n login view ƒë·ªÉ b·∫°n th·∫•y l·ªói
      }
    }

    // logout quay v·ªÅ login (ƒë·ªÉ main g·ªçi)
    window.spaGoLogin = function () {
      const loginView = document.getElementById("view-login");
      const mainView  = document.getElementById("view-main");
      mainView.style.display = "none";
      loginView.style.display = "block";
      document.body.classList.remove("door-opening");
      localStorage.removeItem(LS_SESSION);
      setTab("login");
    };

    function openDoorAndGo() {
      try { bell.currentTime = 0; bell.play(); } catch (e) {}
      document.body.classList.add("door-opening");
      setTimeout(() => { spaLoadMain(); }, 900);
    }

    // ================== REGISTER ==================
    document.getElementById("registerBtn").addEventListener("click", () => {
      const u = document.getElementById("regUser").value.trim();
      const p = document.getElementById("regPass").value.trim();
      const k = document.getElementById("regKey").value.trim();

      if (!u || !p || !k) return showMsg("Vui l√≤ng nh·∫≠p ƒë·ªß Username, Password v√† System Key.", "err");
      if (k !== PUBLISHER_SYSTEM_KEY) return showMsg("System Key kh√¥ng ƒë√∫ng. B·∫°n c·∫ßn key t·ª´ nh√† ph√°t h√†nh.", "err");

      const users = loadUsers();
      if (users[u]) return showMsg("Username ƒë√£ t·ªìn t·∫°i. H√£y ch·ªçn t√™n kh√°c.", "err");

      users[u] = p; // demo
      saveUsers(users);

      showMsg("ƒêƒÉng k√Ω th√†nh c√¥ng! Chuy·ªÉn sang ƒêƒÉng nh·∫≠p‚Ä¶", "ok");
      setTimeout(() => {
        setTab("login");
        document.getElementById("loginUser").value = u;
        document.getElementById("loginPass").focus();
      }, 800);
    });

    // ================== LOGIN ==================
    document.getElementById("loginBtn").addEventListener("click", () => {
      const u = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();

      if (!u || !p) return showMsg("Vui l√≤ng nh·∫≠p Username v√† Password.", "err");

      const users = loadUsers();
      if (!users[u] || users[u] !== p) return showMsg("Sai username ho·∫∑c password.", "err");

      localStorage.setItem(LS_SESSION, u);
      showMsg("ƒêƒÉng nh·∫≠p th√†nh c√¥ng! ƒêang v√†o h·ªá th·ªëng‚Ä¶", "ok");
      openDoorAndGo();
    });

    // Enter submit
    document.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      if (loginForm.style.display !== "none") document.getElementById("loginBtn").click();
      else document.getElementById("registerBtn").click();
    });
  </script>
</body>
</html>
